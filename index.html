<script>
    let sheetId = "1YVO59qBs1atrOgY6rJLUI75-KzKBF78iN5ZH8r6Yv0o";
    let clientId = "203005866385-jm1rkp0u1j94i8iilgs4dn9l7j5ivm2a.apps.googleusercontent.com";
    let redirectUri = "https://gk895.github.io/FamGame/";
    let scope = "https://www.googleapis.com/auth/spreadsheets";
    let apiKey = "AIzaSyCtGnPiwGVuByuzMxeprkhfVP4ZTfrAXus";
    let accessToken = null;

    async function authenticate() {
        let authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}&prompt=consent`;
        window.location.href = authUrl;
    }

    function getAccessTokenFromURL() {
        let params = new URLSearchParams(window.location.hash.substring(1));
        return params.get("access_token");
    }

    async function fetchPoints() {
        if (!accessToken) {
            console.error("No access token found.");
            return { husbandPoints: 0, wifePoints: 0 };
        }

        let sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A2:C2?key=${apiKey}`;
        let response = await fetch(sheetUrl, {
            headers: { "Authorization": `Bearer ${accessToken}` }
        });

        let data = await response.json();
        let values = data.values ? data.values[0] : [0, 0, 0];
        let husbandPoints = parseInt(values[0]) || 0;
        let wifePoints = parseInt(values[1]) || 0;

        updateUI(husbandPoints, wifePoints);
        return { husbandPoints, wifePoints };
    }

    async function updatePoints(husbandPoints, wifePoints) {
        if (!accessToken) {
            console.error("No access token found.");
            return;
        }

        let values = [[husbandPoints, wifePoints, husbandPoints + wifePoints]];
        let updateUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A2:C2?valueInputOption=RAW`;

        await fetch(updateUrl, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ values })
        });

        updateUI(husbandPoints, wifePoints);
    }

    async function addPoints(person, value) {
        let currentPoints = await fetchPoints();
        let husbandPoints = currentPoints.husbandPoints;
        let wifePoints = currentPoints.wifePoints;

        if (person === 'husband') {
            husbandPoints += value;
        } else if (person === 'wife') {
            wifePoints += value;
        }

        await updatePoints(husbandPoints, wifePoints);
    }

    async function redeemPoints(cost) {
        let currentPoints = await fetchPoints();
        let husbandPoints = currentPoints.husbandPoints;
        let wifePoints = currentPoints.wifePoints;
        let totalPoints = husbandPoints + wifePoints;

        if (totalPoints < cost) {
            alert("Not enough points to redeem this reward!"); // Show message if not enough points
            return;
        }

        // Deduct points proportionally from both
        let husbandShare = husbandPoints / totalPoints;
        let wifeShare = wifePoints / totalPoints;

        husbandPoints -= Math.round(cost * husbandShare);
        wifePoints -= Math.round(cost * wifeShare);

        await updatePoints(husbandPoints, wifePoints);
    }

    function updateUI(husbandPoints, wifePoints) {
        let totalPoints = husbandPoints + wifePoints;
        document.getElementById('totalPoints').innerText = totalPoints;
        document.getElementById('husbandPercent').innerText = husbandPoints;
        document.getElementById('wifePercent').innerText = wifePoints;
    }

    function resetPoints() {
        updatePoints(0, 0);
    }

    // Get access token & authenticate if missing
    accessToken = getAccessTokenFromURL();
    if (!accessToken) {
        authenticate();
    } else {
        fetchPoints();
    }
</script>
